# $Id$
#
# Replacement for "configure".
# Performs some test compiles, to check for headers and functions.
# Unlike configure, it does not run any test code, so it is more friendly for
# cross compiles.

# This Makefile needs parameters to operate; check that they were specified:
# - output directory
ifeq ($(OUTDIR),)
$(error Missing parameter: OUTDIR)
endif
# - command line to invoke compiler + options
ifeq ($(COMPILE),)
$(error Missing parameter: COMPILE)
endif

# Result files.
LOG:=$(OUTDIR)/probe.log
OUTPUT:=$(OUTDIR)/probed_defs.hh

# Functions
# =========

FTRUNCATE_FUNC:=ftruncate
FTRUNCATE_HEADER:=<unistd.h>

GETTIMEOFDAY_FUNC:=gettimeofday
GETTIMEOFDAY_HEADER:=<sys/time.h>

MMAP_FUNC:=mmap
MMAP_HEADER:=<sys/mman.h>

USLEEP_FUNC:=usleep
USLEEP_HEADER:=<unistd.h>

X11_FUNC:=XtMalloc
X11_HEADER:=<X11/Intrinsic.h>

CHECK_FUNCS:=FTRUNCATE GETTIMEOFDAY MMAP USLEEP X11

# Headers
# =======

GL_HEADER:=<gl.h>

GL_GL_HEADER:=<GL/gl.h>

SYS_MMAN_HEADER:=<sys/mman.h>

SYS_SOCKET_HEADER:=<sys/socket.h>

CHECK_HEADERS:=GL GL_GL SYS_MMAN SYS_SOCKET

# Implementation
# ==============

.PHONY: all init $(CHECK_FUNCS) $(CHECK_HEADERS)

# Default target.
all: $(CHECK_FUNCS) $(CHECK_HEADERS)

# Create empty log and result files.
init:
	@mkdir -p $(OUTDIR)
	@echo "Probing system:" > $(LOG)
	@echo "// Automatically generated by build system." > $(OUTPUT)

# Probe for function:
# Try to include the necessary header and get the function address.
$(CHECK_FUNCS): init
	@echo "#include $($@_HEADER)" > $(OUTDIR)/$@.cc
	@echo "void (*f)() = reinterpret_cast<void (*)()>($($@_FUNC));" >> $(OUTDIR)/$@.cc
	@if $(COMPILE) -c $(OUTDIR)/$@.cc -o $(OUTDIR)/$@.o 2>> $(LOG); \
	then echo "Found function: $@" >> $(LOG); \
	     echo "#define HAVE_$@ 1" >> $(OUTPUT); \
	else echo "Missing function: $@" >> $(LOG); \
	     echo "// #undef HAVE_$@" >> $(OUTPUT); \
	fi
	@rm -f $(OUTDIR)/$@.cc $(OUTDIR)/$@.o

# Probe for header:
# Try to include the header.
$(CHECK_HEADERS): init
	@echo "#include $($@_HEADER)" > $(OUTDIR)/$@.cc
	@if $(COMPILE) -c $(OUTDIR)/$@.cc -o $(OUTDIR)/$@.o 2>> $(LOG); \
	then echo "Found header: $@" >> $(LOG); \
	     echo "#define HAVE_$@_H 1" >> $(OUTPUT); \
	else echo "Missing header: $@" >> $(LOG); \
	     echo "// #undef HAVE_$@_H" >> $(OUTPUT); \
	fi
	@rm -f $(OUTDIR)/$@.cc $(OUTDIR)/$@.o

